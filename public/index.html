<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=0.5, maximum-scale=3.0, user-scalable=yes">
  <title id="page-title">Loading...</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-gradient"></script>
  <style>
    :root {
      --primary-color: #075E54;
      --secondary-color: #128C7E;
      --accent-color: #25D366;
      --background-color: #F0F2F5;
      --card-background: #FFFFFF;
      --text-color: #333;
      --light-text-color: #888;
      --danger-color: #ff6b6b;
      --success-color: #1dd1a1;
      --warning-color: #feca57;
      --info-color: #54a0ff;
      --shadow: 0 12px 32px rgba(0, 0, 0, 0.1);
      --border-radius: 20px;
      --transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e7eb 100%);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      overflow-x: hidden;
      font-size: clamp(14px, 2vw, 16px);
      line-height: 1.5;
    }

    /* Sidebar - Fluid Responsive */
    .sidebar {
      width: clamp(280px, 25vw, 350px);
      min-width: 280px;
      background: linear-gradient(160deg, var(--primary-color) 0%, #054a41 100%);
      color: white;
      padding: clamp(15px, 3vw, 25px);
      height: 100vh;
      display: flex;
      flex-direction: column;
      box-shadow: 5px 0 25px rgba(0, 0, 0, 0.1);
      z-index: 10;
      transition: var(--transition);
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* Main Content - Fluid Responsive */
    .main-content {
      flex: 1;
      min-width: 0;
      padding: clamp(15px, 4vw, 35px);
      height: 100vh;
      overflow-y: auto;
      overflow-x: hidden;
      background: transparent;
    }

    /* Universal Analytics Grid */
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(clamp(140px, 20vw, 220px), 1fr));
      gap: clamp(10px, 2vw, 20px);
      margin-bottom: clamp(15px, 3vw, 25px);
    }

    .analytic-item {
      background: rgba(255, 255, 255, 0.8);
      padding: clamp(12px, 3vw, 20px);
      border-radius: clamp(8px, 1.5vw, 12px);
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: var(--transition);
      min-height: clamp(80px, 12vw, 120px);
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .analytic-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .analytic-item strong {
      display: block;
      font-size: clamp(0.7rem, 2vw, 0.9rem);
      color: var(--light-text-color);
      margin-bottom: clamp(4px, 1vw, 8px);
      font-weight: 600;
      line-height: 1.3;
    }

    .analytic-item span {
      font-size: clamp(1.2rem, 4vw, 2rem);
      font-weight: 700;
      color: var(--secondary-color);
      line-height: 1.2;
    }

    /* Logs Container */
    .logs-container {
      max-height: 400px;
      overflow-y: auto;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.5);
    }

    .log-entry {
      display: grid;
      grid-template-columns: 1fr 1fr 100px 1fr;
      gap: 15px;
      padding: 15px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      align-items: center;
      transition: background 0.2s ease;
    }

    .log-entry:hover {
      background: rgba(0, 200, 83, 0.05);
    }

    .log-header {
      background: var(--secondary-color);
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 5;
    }

    /* Filters */
    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filters input[type="date"] {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
    }

    .filters .btn {
      padding: 8px 16px;
      font-size: 14px;
      width: auto;
    }

    /* Header */
    .header {
      margin-bottom: 30px;
    }

    .header-content h2 {
      font-size: clamp(1.5rem, 5vw, 2.5rem);
      font-weight: 700;
      color: var(--text-color);
      margin-bottom: clamp(6px, 1vw, 10px);
      line-height: 1.2;
    }

    .header-content p {
      color: var(--light-text-color);
      font-size: clamp(0.9rem, 2.5vw, 1.1rem);
      line-height: 1.4;
    }

    /* Universal Chart Container */
    .chart-container {
      height: clamp(200px, 40vw, 400px);
      position: relative;
      width: 100%;
    }

    /* Universal Breakpoints - All Screen Sizes */
    
    /* Ultra-wide screens (4K+) */
    @media (min-width: 2560px) {
      .sidebar {
        width: clamp(350px, 20vw, 400px);
      }
      .analytics-grid {
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      }
    }
    
    /* Large screens */
    @media (min-width: 1920px) and (max-width: 2559px) {
      .analytics-grid {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      }
    }
    
    /* Standard desktop */
    @media (min-width: 1200px) and (max-width: 1919px) {
      .analytics-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
    }
    
    /* Tablet landscape */
    @media (min-width: 768px) and (max-width: 1199px) {
      body {
        flex-direction: row;
      }
      .sidebar {
        width: clamp(250px, 30vw, 300px);
      }
      .analytics-grid {
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }
    }
    
    /* Mobile landscape & tablet portrait */
    @media (min-width: 481px) and (max-width: 767px) {
      body {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        height: auto;
        min-width: auto;
      }
      .main-content {
        height: auto;
      }
      .analytics-grid {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      }
      .log-entry {
        grid-template-columns: 1fr 1fr;
        gap: clamp(8px, 2vw, 12px);
      }
    }
    
    /* Mobile portrait */
    @media (max-width: 480px) {
      body {
        flex-direction: column;
        font-size: clamp(12px, 3vw, 14px);
      }
      .sidebar {
        width: 100%;
        height: auto;
        min-width: auto;
        padding: clamp(10px, 4vw, 20px);
      }
      .main-content {
        height: auto;
        padding: clamp(10px, 4vw, 20px);
      }
      .analytics-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: clamp(8px, 2vw, 12px);
      }
      .log-entry {
        grid-template-columns: 1fr;
        gap: clamp(6px, 1.5vw, 10px);
        text-align: left;
      }
      .log-header {
        display: none;
      }
      .log-entry > div:before {
        content: attr(data-label);
        font-weight: bold;
        display: inline-block;
        width: clamp(60px, 20vw, 80px);
        color: var(--secondary-color);
        font-size: clamp(10px, 2.5vw, 12px);
      }
      .filters {
        flex-direction: column;
        gap: clamp(8px, 2vw, 12px);
      }
      .filters input[type="date"],
      .filters .btn {
        width: 100%;
      }
    }
    
    /* Smartwatch & very small screens */
    @media (max-width: 320px) {
      body {
        font-size: clamp(10px, 4vw, 12px);
      }
      .analytics-grid {
        grid-template-columns: 1fr;
        gap: clamp(6px, 2vw, 10px);
      }
      .analytic-item {
        min-height: clamp(60px, 15vw, 80px);
        padding: clamp(8px, 3vw, 12px);
      }
      .card {
        padding: clamp(10px, 4vw, 15px);
        margin-bottom: clamp(8px, 2vw, 12px);
      }
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 40px;
    }

    .logo-icon {
      width: 50px;
      height: 50px;
      background: var(--accent-color);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      color: white;
    }

    .logo-icon i {
      color: white;
    }

    .logo h1 {
      font-size: clamp(1.2rem, 3vw, 1.8rem);
      font-weight: 700;
      letter-spacing: -0.5px;
      line-height: 1.2;
    }

    .status-container {
      background: rgba(255, 255, 255, 0.12);
      border-radius: 18px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(5px);
    }

    .status-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .status-header h3 {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 14px;
      margin-bottom: 15px;
    }

    .indicator {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      position: relative;
    }

    .indicator::after {
      content: '';
      position: absolute;
      top: -4px;
      left: -4px;
      right: -4px;
      bottom: -4px;
      border-radius: 50%;
      opacity: 0.5;
      animation: pulse 2s infinite;
    }

    .ready { background-color: var(--accent-color); }
    .ready::after { background-color: var(--accent-color); }
    .qr_pending { background-color: var(--warning-color); }
    .qr_pending::after { background-color: var(--warning-color); }
    .authenticated { background-color: var(--info-color); }
    .authenticated::after { background-color: var(--info-color); }
    .disconnected { background-color: var(--danger-color); }
    .disconnected::after { background-color: var(--danger-color); }
    .processing { background-color: #9b59b6; }
    .processing::after { background-color: #9b59b6; }

    .qr-container {
      text-align: center;
      padding: 15px;
      background: white;
      border-radius: 14px;
      overflow: hidden;
      max-width: 100%;
      box-sizing: border-box;
    }
    
    .qr-container img {
      max-width: 100%;
      height: auto;
      border-radius: 10px;
      display: block;
      margin: 0 auto;
    }

    /* Bot Status Indicator */
    .bot-status-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 14px;
      margin-bottom: 15px;
    }

    .bot-indicator {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      position: relative;
      flex-shrink: 0;
    }

    .bot-indicator::after {
      content: '';
      position: absolute;
      top: -4px;
      left: -4px;
      right: -4px;
      bottom: -4px;
      border-radius: 50%;
      opacity: 0.5;
      animation: pulse 2s infinite;
    }

    .bot-running { 
      background-color: #00c853; 
    }
    .bot-running::after { 
      background-color: #00c853; 
    }
    .bot-stopped { 
      background-color: #ff6b6b; 
    }
    .bot-stopped::after { 
      background-color: #ff6b6b; 
    }
    .bot-unknown { 
      background-color: #feca57; 
    }
    .bot-unknown::after { 
      background-color: #feca57; 
    }

    .card {
      background: var(--card-background);
      border-radius: clamp(12px, 2vw, 20px);
      box-shadow: var(--shadow);
      padding: clamp(15px, 4vw, 28px);
      margin-bottom: clamp(15px, 3vw, 25px);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: var(--secondary-color);
      border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 25px;
      font-size: 1.1rem;
    }

    .card-header i {
      color: var(--secondary-color);
      font-size: 1.8rem;
      background: rgba(18, 140, 126, 0.1);
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 14px;
    }
    
    .card-header h3 {
      font-size: clamp(1.1rem, 3vw, 1.4rem);
      font-weight: 700;
      color: var(--text-color);
      line-height: 1.3;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      width: 100%;
      box-sizing: border-box;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: clamp(4px, 1vw, 8px);
      padding: clamp(10px, 2vw, 16px) clamp(12px, 3vw, 20px);
      border: none;
      border-radius: clamp(8px, 1.5vw, 14px);
      font-size: clamp(12px, 2.5vw, 14px);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 100%;
      box-sizing: border-box;
      min-width: 0;
      min-height: clamp(40px, 6vw, 48px);
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn i {
      font-size: 1.2rem;
    }

    .btn-primary { 
      background: var(--secondary-color); 
      color: white; 
    }
    .btn-primary:hover { background: #0e7a6d; }
    .btn-danger { 
      background: var(--danger-color); 
      color: white; 
    }
    .btn-danger:hover { background: #ff5252; }
    .btn-success { 
      background: var(--success-color); 
      color: white; 
    }
    .btn-success:hover { background: #10ac84; }
    .btn-warning { 
      background: var(--warning-color); 
      color: white; 
    }

    .input-file-container {
      position: relative;
      display: inline-block;
      width: 100%;
      margin-bottom: 15px;
    }

    .input-file {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .input-file-label {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      border: 2px dashed var(--secondary-color);
      border-radius: 14px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      width: 100%;
      text-align: center;
      color: var(--secondary-color);
      background: rgba(18, 140, 126, 0.05);
    }

    .input-file:hover + .input-file-label,
    .input-file:focus + .input-file-label {
      background: rgba(18, 140, 126, 0.15);
      transform: translateY(-2px);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 40px;
      overflow-y: auto;
      height: 100vh;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      grid-auto-rows: min-content;
      gap: 30px;
    }

    .header {
      grid-column: 1 / -1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      background: var(--card-background);
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
    }

    .header-content h2 {
      font-size: 2.2rem;
      font-weight: 800;
      color: var(--primary-color);
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }

    .header-content p {
      color: var(--light-text-color);
      font-size: 1.1rem;
      max-width: 600px;
    }

    .theme-switch-wrapper {
      display: flex;
      align-items: center;
      gap: 15px;
      background: rgba(0, 0, 0, 0.03);
      padding: 12px 20px;
      border-radius: 50px;
    }

    .theme-switch {
      display: inline-block;
      height: 26px;
      position: relative;
      width: 55px;
    }

    .theme-switch input { display:none; }

    .slider {
      background-color: #ccc;
      bottom: 0;
      cursor: pointer;
      left: 0;
      position: absolute;
      right: 0;
      top: 0;
      transition: .4s;
    }

    .slider:before {
      background-color: #fff;
      bottom: 3px;
      content: "";
      height: 20px;
      left: 3px;
      position: absolute;
      transition: .4s;
      width: 20px;
    }

    input:checked + .slider {
      background-color: var(--accent-color);
    }

    input:checked + .slider:before {
      transform: translateX(29px);
    }

    .slider.round { border-radius: 34px; }
    .slider.round:before { border-radius: 50%; }

    /* Analytics Grid */
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .analytic-item {
      background: linear-gradient(135deg, #f8fafc 0%, #edf9f7 100%);
      padding: 25px 20px;
      border-radius: 18px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(0, 0, 0, 0.03);
    }

    .analytic-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
    }

    .analytic-item::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--secondary-color);
      border-radius: 18px 18px 0 0;
    }

    .analytic-item strong {
      display: block;
      font-size: 1rem;
      margin-bottom: 15px;
      color: var(--light-text-color);
      font-weight: 600;
    }

    .analytic-item span {
      font-size: 2.2rem;
      font-weight: 800;
      color: var(--primary-color);
      transition: transform 0.5s ease;
      display: block;
    }

    .analytic-item.updating span {
      transform: rotateX(360deg);
    }

    /* Filters */
    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .filters input[type="date"] {
      padding: 14px;
      border-radius: 14px;
      border: 1px solid #e1e5e9;
      background: white;
      font-size: 16px;
      flex: 1;
      min-width: 200px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
    }

    /* Logs */
    .logs-container {
      max-height: 400px;
      overflow-y: auto;
      border-radius: 18px;
      border: 1px solid rgba(0, 0, 0, 0.05);
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.03);
    }

    .log-entry {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 15px;
      padding: 18px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      transition: background 0.2s;
    }

    .log-entry:hover {
      background: rgba(18, 140, 126, 0.03);
    }

    .log-header {
      font-weight: 700;
      background: rgba(18, 140, 126, 0.05);
      position: sticky;
      top: 0;
      z-index: 2;
    }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: var(--secondary-color);
      color: white;
      padding: 20px 30px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      opacity: 0;
      transform: translateY(30px);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 15px;
      max-width: 400px;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast i {
      font-size: 1.8rem;
    }

    /* Chart containers */
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }

    .pie-card .chart-container {
      height: 320px;
    }

    /* Dark Mode */
    body.dark-mode {
      --primary-color: #1d2d2a;
      --secondary-color: #1a3c38;
      --accent-color: #00c853;
      --background-color: #111b21;
      --card-background: #1f2c33;
      --text-color: #e4e8eb;
      --light-text-color: #a0a7ad;
      background: linear-gradient(135deg, #0d161b 0%, #111e25 100%);
    }

    body.dark-mode .sidebar {
      background: linear-gradient(160deg, #1a2d29 0%, #0f1e1b 100%);
      border-right: 1px solid rgba(255, 255, 255, 0.05);
    }

    body.dark-mode .logo .logo-icon {
      background: var(--accent-color);
      color: #fff;
    }

    body.dark-mode .logo .logo-icon i {
      color: #fff !important;
    }

    body.dark-mode .card {
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    body.dark-mode .analytic-item {
      background: linear-gradient(135deg, #1a242a 0%, #1d2f2c 100%);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    body.dark-mode .analytic-item span {
      color: var(--accent-color);
    }

    body.dark-mode .header-content h2 {
      color: var(--accent-color);
    }

    body.dark-mode .header-content p {
      color: var(--light-text-color);
    }

    body.dark-mode .card-header h3 {
      color: var(--text-color);
    }

    body.dark-mode .log-header {
      background: rgba(18, 140, 126, 0.1);
    }

    body.dark-mode .filters input[type="date"] {
      background-color: #1f2c33;
      color: var(--text-color);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    body.dark-mode .input-file-label {
      border-color: var(--accent-color);
      color: var(--accent-color);
      background: rgba(0, 200, 83, 0.05);
    }

    body.dark-mode .logs-container {
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    /* Dark mode chart improvements */
    body.dark-mode .chart-container {
      background: rgba(255, 255, 255, 0.02);
      border-radius: 12px;
      padding: 10px;
    }

    /* Chart container improvements */
    .chart-container {
      position: relative;
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Ensure pie chart legend doesn't get cut off */
    .pie-card .chart-container {
      padding-bottom: 60px;
    }

    body.dark-mode .pie-card {
      background: linear-gradient(135deg, #1a242a 0%, #1d2f2c 100%);
    }

    body.dark-mode .pie-card .card-header h3 {
      color: var(--text-color);
    }

    body.dark-mode .pie-card .card-header i {
      color: var(--accent-color);
    }

    /* Ensure all sidebar icons are visible in dark mode */
    body.dark-mode .sidebar .card-header i {
      color: var(--accent-color);
    }

    body.dark-mode .sidebar .btn i {
      color: inherit;
    }

    body.dark-mode .sidebar .input-file-label i {
      color: var(--accent-color);
    }

    /* Dark mode bot status indicator */
    body.dark-mode .bot-status-indicator {
      background: rgba(255, 255, 255, 0.08);
    }

    body.dark-mode .bot-status-indicator span {
      color: var(--text-color);
    }

    body.dark-mode .bot-status-indicator i {
      color: var(--accent-color) !important;
    }

    /* Dark mode status badges - attractive colors only */
    body.dark-mode .status-sent { 
      background: linear-gradient(135deg, rgba(0, 200, 83, 0.15) 0%, rgba(0, 200, 83, 0.25) 100%); 
      color: #00c853 !important; 
      border: 1px solid rgba(0, 200, 83, 0.4);
      box-shadow: 0 4px 12px rgba(0, 200, 83, 0.2);
    }
    
    body.dark-mode .status-seen { 
      background: linear-gradient(135deg, rgba(37, 211, 102, 0.15) 0%, rgba(37, 211, 102, 0.25) 100%); 
      color: #25D366 !important; 
      border: 1px solid rgba(37, 211, 102, 0.4);
      box-shadow: 0 4px 12px rgba(37, 211, 102, 0.2);
    }
    
    body.dark-mode .status-failed { 
      background: linear-gradient(135deg, rgba(255, 107, 107, 0.15) 0%, rgba(255, 107, 107, 0.25) 100%); 
      color: #ff6b6b !important; 
      border: 1px solid rgba(255, 107, 107, 0.4);
      box-shadow: 0 4px 12px rgba(255, 107, 107, 0.2);
    }
    
    body.dark-mode .status-invalid { 
      background: linear-gradient(135deg, rgba(255, 193, 7, 0.15) 0%, rgba(255, 193, 7, 0.25) 100%); 
      color: #ffc107 !important; 
      border: 1px solid rgba(255, 193, 7, 0.4);
      box-shadow: 0 4px 12px rgba(255, 193, 7, 0.2);
    }

    body.dark-mode .status-pending { 
      background: linear-gradient(135deg, rgba(156, 39, 176, 0.15) 0%, rgba(156, 39, 176, 0.25) 100%); 
      color: #9c27b0 !important; 
      border: 1px solid rgba(156, 39, 176, 0.4);
      box-shadow: 0 4px 12px rgba(156, 39, 176, 0.2);
    }

    /* Dark mode main content icons */
    body.dark-mode .main-content i {
      color: var(--accent-color) !important;
    }

    /* Dark mode analytics icons */
    body.dark-mode .analytics-grid .card i {
      color: var(--accent-color) !important;
    }

    body.dark-mode .analytic-item i {
      color: var(--accent-color) !important;
    }

    body.dark-mode .card-header i {
      color: var(--accent-color) !important;
    }

    /* Dark mode table and log entries */
    body.dark-mode .log-entry {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    body.dark-mode .log-entry:hover {
      background: rgba(0, 200, 83, 0.05);
    }

    /* Dark mode theme toggle moon icon */
    body.dark-mode .theme-switch-wrapper i {
      color: #feca57 !important;
    }

    /* Dark mode buttons */
    body.dark-mode .btn {
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    body.dark-mode .btn:hover {
      background: rgba(0, 200, 83, 0.1);
      border-color: var(--accent-color);
    }

    /* Ensure all FontAwesome icons are visible in dark mode */
    body.dark-mode .fa, 
    body.dark-mode .fas, 
    body.dark-mode .far, 
    body.dark-mode .fab {
      color: var(--accent-color) !important;
    }

    /* Exception for button icons which should inherit color */
    body.dark-mode .btn .fa, 
    body.dark-mode .btn .fas, 
    body.dark-mode .btn .far, 
    body.dark-mode .btn .fab {
      color: inherit !important;
    }

    /* Animations */
    @keyframes pulse {
      0% { transform: scale(0.8); opacity: 0.7; }
      50% { transform: scale(1.2); opacity: 0.3; }
      100% { transform: scale(0.8); opacity: 0.7; }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Tablet Responsiveness */
    @media (max-width: 1200px) {
      .sidebar {
        width: 250px;
        min-width: 250px;
      }
      
      .analytics-grid {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }
      
      .chart-container {
        height: 300px;
      }
    }

    @media (max-width: 900px) {
      body {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        min-width: auto;
        height: auto;
        position: relative;
        overflow-y: visible;
      }
      
      .main-content {
        height: auto;
        padding: 20px;
        overflow-x: hidden;
      }
      
      .qr-container {
        max-width: 200px;
        margin: 0 auto;
      }
      
      .analytics-grid {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 15px;
      }
      
      .chart-container {
        height: 280px;
      }
    }

    /* Small Mobile */
    @media (max-width: 480px) {
      .main-content {
        padding: 10px;
      }
      
      .card {
        padding: 15px;
        margin-bottom: 10px;
      }
      
      .analytics-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }
      
      .analytic-item {
        padding: 12px;
      }
      
      .analytic-item span {
        font-size: 1.2rem;
      }
      
      .analytic-item strong {
        font-size: 0.8rem;
      }
      
      .chart-container {
        height: 200px;
      }
      
      .header-content h2 {
        font-size: 1.3rem;
      }
      
      .card-header h3 {
        font-size: 1.1rem;
      }
      
      .btn {
        padding: 10px 12px;
        font-size: 13px;
      }
    }

    @media (max-width: 600px) {
      .log-entry {
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto auto;
      }
      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 20px;
      }
    }

    /* New chart styling */
    .chart-card {
      grid-column: span 2;
    }

    .half-chart {
      grid-column: span 1;
    }

    @media (max-width: 1200px) {
      .chart-card, .half-chart {
        grid-column: 1 / -1;
      }
    }

    /* Special styling for the pie chart card */
    .pie-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 30px;
      min-height: 400px;
    }

    .pie-card .card-header {
      justify-content: center;
      margin-bottom: 20px;
    }

    .pie-card .chart-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      min-height: 300px;
    }

    #statusPieChart {
      max-width: 280px;
      max-height: 280px;
      margin: 0 auto;
    }

    /* Status badges in logs */
    .status-badge {
      padding: 6px 12px;
      border-radius: 50px;
      font-size: 0.85rem;
      font-weight: 600;
      display: inline-block;
    }

    .status-sent { background: rgba(37, 211, 102, 0.15); color: var(--success-color); }
    .status-failed { background: rgba(255, 107, 107, 0.15); color: var(--danger-color); }
    .status-invalid { background: rgba(254, 202, 87, 0.15); color: var(--warning-color); }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="logo">
      <div class="logo-icon">
        <i class="fab fa-whatsapp"></i>
      </div>
      <h1 id="logo-text">Loading...</h1>
    </div>
    
    <div class="status-container">
      <div class="status-header">
        <h3>Connection Status</h3>
        <div class="theme-switch-wrapper">
          <label class="theme-switch">
            <input type="checkbox" id="theme-toggle">
            <span class="slider round"></span>
          </label>
          <i class="fas fa-moon"></i>
        </div>
      </div>
      <div class="status-indicator">
        <div class="indicator" id="statusIndicator"></div>
        <span id="statusText">Connecting...</span>
      </div>
      <div class="bot-status-indicator">
        <div class="bot-indicator" id="botStatusIndicator"></div>
        <span id="botStatusText">Bot Status: Unknown</span>
      </div>
      <div class="qr-container" id="qrContainer" style="display: none;">
        <p>Scan QR Code to Connect</p>
        <div id="qrCode"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <i class="fas fa-cogs"></i>
        <h3>Bot Controls</h3>
      </div>
      <div class="controls-grid">
        <button id="startBtn" class="btn btn-success" disabled><i class="fas fa-play"></i> Start</button>
        <button id="stopBtn" class="btn btn-danger" disabled><i class="fas fa-stop"></i> Stop</button>
      </div>
      <div style="margin-top: 10px;">
        <button id="resetBtn" class="btn btn-warning" style="width: 100%;"><i class="fas fa-sync-alt"></i> Reset</button>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header">
        <i class="fas fa-file-pdf"></i>
        <h3>Upload Catalog</h3>
      </div>
      <div class="input-file-container">
        <input type="file" id="pdfUpload" class="input-file" accept=".pdf">
        <label for="pdfUpload" class="input-file-label">
          <i class="fas fa-cloud-upload-alt"></i>
          <span id="pdfFileName">Choose a PDF file</span>
        </label>
      </div>
      <button id="uploadBtn" class="btn btn-primary"><i class="fas fa-upload"></i> Upload Catalog</button>
    </div>
  </div>

  <div class="main-content">
    <div class="header">
      <div class="header-content">
        <h2>WhatsApp Outreach Dashboard</h2>
        <p>Monitor your outreach campaigns in real-time with detailed analytics</p>
      </div>
    </div>

    <div class="card chart-card">
      <div class="card-header">
        <i class="fas fa-chart-line"></i>
        <h3>Campaign Analytics</h3>
      </div>
      <div class="filters">
        <input type="date" id="startDate">
        <input type="date" id="endDate">
        <button id="filterBtn" class="btn btn-primary">Apply Filter</button>
        <button id="resetFilterBtn" class="btn">Reset</button>
      </div>
      <div id="analyticsContainer" class="analytics-grid">
        <div class="analytic-item"><strong>Total Sent</strong><span id="totalSent">0</span></div>
        <div class="analytic-item"><strong>Failed</strong><span id="totalFailed">0</span></div>
        <div class="analytic-item"><strong>Invalid Numbers</strong><span id="totalInvalid">0</span></div>
        <div class="analytic-item"><strong>Unique Recipients</strong><span id="uniqueRecipients">0</span></div>
        <div class="analytic-item"><strong>Most Active Hour</strong><span id="mostActiveHour">-</span></div>
        <div class="analytic-item"><strong>Catalogs Sent</strong><span id="catalogsSent">0</span></div>
      </div>
      <div style="margin-top:40px; height: 300px;">
        <canvas id="analyticsChart"></canvas>
      </div>
    </div>

    <div class="card half-chart">
      <div class="card-header">
        <i class="fas fa-chart-bar"></i>
        <h3>Hourly Engagement</h3>
      </div>
      <div class="chart-container">
        <canvas id="hourlyTrendChart"></canvas>
      </div>
    </div>
    
    <div class="card pie-card">
      <div class="card-header">
        <i class="fas fa-chart-pie"></i>
        <h3>Status Distribution</h3>
      </div>
      <div class="chart-container">
        <canvas id="statusPieChart"></canvas>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <i class="fas fa-chart-bar"></i>
        <h3>Daily Activity</h3>
      </div>
      <div class="analytics-grid">
        <div class="analytic-item"><strong>Today's Messages</strong><span id="todayMessages">0</span></div>
        <div class="analytic-item"><strong>Today's Catalogs</strong><span id="todayCatalogs">0</span></div>
        <div class="analytic-item"><strong>Success Rate</strong><span id="successRate">0%</span></div>
        <div class="analytic-item"><strong>Processing Speed</strong><span id="processingSpeed">0/min</span></div>
      </div>
    </div>
    
    
    
    <div class="card">
      <div class="card-header">
        <i class="fas fa-history"></i>
        <h3>Message Logs</h3>
      </div>
      <div class="logs-container">
        <div class="log-entry log-header">
          <div>Recipient</div>
          <div>Name</div>
          <div>Status</div>
          <div>Timestamp</div>
        </div>
        <div id="logsContainer">
          <!-- Logs will be populated here -->
        </div>
      </div>
    </div>
  </div>
  
  <div class="toast" id="toast">
    <i class="fas fa-check-circle"></i>
    <span id="toastMessage">PDF uploaded successfully!</span>
  </div>
  
  <script>
    // DOM elements
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    const qrContainer = document.getElementById('qrContainer');
    const qrCodeElement = document.getElementById('qrCode');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const resetBtn = document.getElementById('resetBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const pdfUpload = document.getElementById('pdfUpload');
    const logsContainer = document.getElementById('logsContainer');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const filterBtn = document.getElementById('filterBtn');
    const resetFilterBtn = document.getElementById('resetFilterBtn');
    const pdfFileName = document.getElementById('pdfFileName');
    const themeToggle = document.getElementById('theme-toggle');

    // Set current dates for filters
    const today = new Date();
    const startOfJuly = new Date(2025, 6, 1); // July 1st, 2025 (month is 0-indexed)
    
    // Format dates as YYYY-MM-DD for input[type="date"]
    const formatDate = (date) => {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    };
    
    startDateInput.value = formatDate(startOfJuly);
    endDateInput.value = formatDate(today);

    // Status mapping
    const statusMap = {
      'disconnected': { text: 'Disconnected', class: 'disconnected' },
      'qr_pending': { text: 'QR Code Pending', class: 'qr_pending' },
      'authenticated': { text: 'Authenticated', class: 'authenticated' },
      'ready': { text: 'Ready to Start', class: 'ready' },
      'processing': { text: 'Processing Messages', class: 'processing' }
    };
    
    // Initialize charts
    let analyticsChart, hourlyTrendChart, statusPieChart;
    let appConfig = null;

    // Load configuration from server
    async function loadConfig() {
      try {
        const response = await fetch('/config');
        appConfig = await response.json();
        
        // Update page title and branding
        document.getElementById('page-title').textContent = appConfig.branding.dashboardTitle;
        document.getElementById('logo-text').textContent = appConfig.branding.logoText;
        
        // Update CSS custom properties for colors
        document.documentElement.style.setProperty('--primary-color', appConfig.branding.primaryColor);
        document.documentElement.style.setProperty('--secondary-color', appConfig.branding.secondaryColor);
        document.documentElement.style.setProperty('--accent-color', appConfig.branding.accentColor);
        
        console.log('Configuration loaded:', appConfig);
      } catch (error) {
        console.error('Failed to load configuration:', error);
        // Fallback to default values
        document.getElementById('page-title').textContent = 'WhatsApp Bot Dashboard';
        document.getElementById('logo-text').textContent = 'WhatsApp Bot';
      }
    }
    
    // Initialize the dashboard
    function initDashboard() {
      updateStatus('ready', false);
      loadLogs();
      loadAnalytics();
      initCharts();
    }
    
    // Update connection status
    function updateStatus(status, processing) {
      const statusInfo = statusMap[status] || statusMap.disconnected;
      statusIndicator.className = `indicator ${statusInfo.class}`;
      statusText.textContent = statusInfo.text;
      startBtn.disabled = status !== 'ready' || processing;
      stopBtn.disabled = !processing;
    }

    // Update bot running status
    function updateBotStatus(processing) {
      const botStatusIndicator = document.getElementById('botStatusIndicator');
      const botStatusText = document.getElementById('botStatusText');
      
      if (processing) {
        botStatusIndicator.className = 'bot-indicator bot-running';
        botStatusText.textContent = 'Bot Status: Running';
      } else {
        botStatusIndicator.className = 'bot-indicator bot-stopped';
        botStatusText.textContent = 'Bot Status: Stopped';
      }
    }
    
    // Show QR code
    function showQR(qrData) {
      qrContainer.style.display = 'block';
      QRCode.toDataURL(qrData, { 
        width: 200, 
        margin: 2,
        color: {
          dark: '#000000',
          light: '#FFFFFF'
        }
      }, (err, url) => {
        if (err) return;
        qrCodeElement.innerHTML = `<img src="${url}" alt="QR Code" style="max-width: 100%; height: auto;">`;
      });
    }
    
    // Hide QR code
    function hideQR() {
      qrContainer.style.display = 'none';
      qrCodeElement.innerHTML = '';
    }
    
    // Show toast notification
    function showToast(message, isSuccess = true) {
      const icon = toast.querySelector('i');
      icon.className = isSuccess ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
      toast.style.background = isSuccess ? 'var(--success-color)' : 'var(--danger-color)';
      toastMessage.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3500);
    }
    
    // Load message logs
    async function loadLogs() {
      try {
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        let url = '/logs';
        if (startDate && endDate) {
            const params = new URLSearchParams({ startDate, endDate });
            url += `?${params.toString()}`;
        }
        const response = await fetch(url);
        const logs = await response.json();
        logsContainer.innerHTML = '';
        
        logs.forEach(log => {
          const logEntry = document.createElement('div');
          logEntry.className = 'log-entry';
          
          // Add status badge class based on status
          let statusClass = 'status-sent';
          if (log.status === 'Sent') statusClass = 'status-sent';
          else if (log.status === 'Failed') statusClass = 'status-failed';
          else if (log.status === 'Invalid') statusClass = 'status-invalid';
          
          logEntry.innerHTML = `
            <div data-label="Phone: ">${log.phone}</div>
            <div data-label="Name: ">${log.name}</div>
            <div data-label="Status: "><span class="status-badge ${statusClass}">${log.status}</span></div>
            <div data-label="Time: ">${new Date(log.timestamp).toLocaleString()}</div>
          `;
          logsContainer.appendChild(logEntry);
        });
      } catch (error) {
        logsContainer.innerHTML = '<div class="log-entry">Error loading logs. Please try again.</div>';
      }
    }

    // Initialize charts with sample data
    function initCharts() {
      // Analytics Chart (Sent/Seen over time)
      const analyticsCtx = document.getElementById('analyticsChart').getContext('2d');
      analyticsChart = new Chart(analyticsCtx, {
        type: 'line',
        data: {
          labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
          datasets: [
            {
              label: 'Messages Sent',
              data: [],
              borderColor: '#128C7E',
              backgroundColor: createGradient(analyticsCtx, '#128C7E', 0.3),
              borderWidth: 3,
              tension: 0.4,
              fill: true,
              pointRadius: 5,
              pointBackgroundColor: '#fff',
              pointBorderWidth: 2
            },
            {
              label: 'Catalogs Sent',
              data: [],
              borderColor: '#25D366',
              backgroundColor: createGradient(analyticsCtx, '#25D366', 0.3),
              borderWidth: 3,
              tension: 0.4,
              fill: true,
              pointRadius: 5,
              pointBackgroundColor: '#fff',
              pointBorderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                font: {
                  size: 14
                },
                usePointStyle: true,
                padding: 20
              }
            },
            tooltip: {
              backgroundColor: 'rgba(255, 255, 255, 0.9)',
              titleColor: '#333',
              bodyColor: '#666',
              borderColor: 'rgba(0, 0, 0, 0.1)',
              borderWidth: 1,
              padding: 12,
              cornerRadius: 12,
              displayColors: false,
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${context.parsed.y}`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              },
              title: {
                display: true,
                text: 'Day',
                color: '#666',
                font: {
                  size: 14
                }
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Messages',
                color: '#666',
                font: {
                  size: 14
                }
              }
            }
          },
          animation: {
            duration: 2000,
            easing: 'easeOutQuart'
          }
        }
      });
      
      // Hourly Trend Chart
      const hourlyCtx = document.getElementById('hourlyTrendChart').getContext('2d');
      hourlyTrendChart = new Chart(hourlyCtx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Messages Sent',
            data: [],
            backgroundColor: createGradient(hourlyCtx, '#128C7E', 0.7),
            borderRadius: 8,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            }
          },
          animation: {
            duration: 2000,
            easing: 'easeOutQuart'
          }
        }
      });
      
      // Status Pie Chart
      const pieCtx = document.getElementById('statusPieChart').getContext('2d');
      statusPieChart = new Chart(pieCtx, {
        type: 'doughnut',
        data: {
          labels: ['Sent', 'Seen', 'Failed', 'Invalid'],
          datasets: [{
            data: [],
            backgroundColor: [
              '#1976D2',  // Blue for Sent
              '#25D366',  // Green for Seen
              '#f44336',  // Red for Failed
              '#ff9800'   // Orange for Invalid
            ],
            borderColor: '#ffffff',
            borderWidth: 2,
            hoverOffset: 20,
            hoverBorderWidth: 3,
            hoverBorderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '60%',
          layout: {
            padding: {
              bottom: 40
            }
          },
          plugins: {
            legend: {
              position: 'bottom',
              align: 'center',
              labels: {
                padding: 15,
                font: {
                  size: 12,
                  weight: '600'
                },
                color: '#333',
                usePointStyle: true,
                pointStyle: 'circle',
                generateLabels: function(chart) {
                  const data = chart.data;
                  if (!data.labels.length || !data.datasets.length) {
                    return [];
                  }
                  const dataset = data.datasets[0];
                  const total = dataset.data.reduce((acc, value) => acc + (value || 0), 0);
                  const isDarkMode = document.body.classList.contains('dark-mode');
                  const textColor = isDarkMode ? '#e4e8eb' : '#333';
                  
                  return data.labels.map((label, i) => {
                    const value = dataset.data[i] || 0;
                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : '0.0';
                    return {
                      text: `${label}: ${percentage}%`,
                      fillStyle: dataset.backgroundColor[i],
                      strokeStyle: dataset.backgroundColor[i],
                      fontColor: textColor,
                      hidden: false,
                      index: i
                    };
                  });
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed !== null) {
                    label += `${context.parsed}%`;
                  }
                  return label;
                }
              }
            }
          },
          animation: {
            animateRotate: true,
            animateScale: true,
            duration: 2000
          }
        }
      });
      
      
    }
    
    // Create gradient for chart backgrounds
    function createGradient(ctx, color, opacity = 1) {
      const gradient = ctx.createLinearGradient(0, 0, 0, 400);
      gradient.addColorStop(0, hexToRgba(color, opacity));
      gradient.addColorStop(1, hexToRgba(color, 0.05));
      return gradient;
    }
    
    // Convert hex to rgba
    function hexToRgba(hex, opacity) {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return `rgba(${r}, ${g}, ${b}, ${opacity})`;
    }

    // Update chart colors for dark mode
    function updateChartColors() {
      const isDarkMode = document.body.classList.contains('dark-mode');
      
      if (statusPieChart) {
        const colorMap = isDarkMode ? 
          {
            'Sent': '#2196F3',      // Blue for Sent
            'Seen': '#00c853',      // Green for Seen (success)
            'Failed': '#ff5252',    // Red for Failed
            'Invalid': '#ffc107',   // Amber for Invalid
            'Pending': '#9c27b0'    // Purple for Pending
          } : 
          {
            'Sent': '#1976D2',      // Blue for Sent
            'Seen': '#25D366',      // Green for Seen (success)
            'Failed': '#f44336',    // Red for Failed
            'Invalid': '#ff9800',   // Orange for Invalid
            'Pending': '#9c27b0'    // Purple for Pending
          };

        // Map colors to match the actual data labels
        const chartColors = statusPieChart.data.labels.map(label => colorMap[label] || '#888888');
        statusPieChart.data.datasets[0].backgroundColor = chartColors;
        statusPieChart.data.datasets[0].borderColor = '#ffffff';
        statusPieChart.data.datasets[0].borderWidth = isDarkMode ? 1 : 2;
        statusPieChart.data.datasets[0].hoverBorderWidth = 3;
        statusPieChart.data.datasets[0].hoverOffset = 20;
        
        // Update legend text color for dark mode
        statusPieChart.options.plugins.legend.labels.color = isDarkMode ? '#e4e8eb' : '#333';
        
        // Force regenerate labels with new colors
        statusPieChart.options.plugins.legend.labels.generateLabels = function(chart) {
          const data = chart.data;
          if (!data.labels.length || !data.datasets.length) {
            return [];
          }
          const dataset = data.datasets[0];
          const total = dataset.data.reduce((acc, value) => acc + (value || 0), 0);
          const textColor = isDarkMode ? '#e4e8eb' : '#333';
          
          return data.labels.map((label, i) => {
            const value = dataset.data[i] || 0;
            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : '0.0';
            return {
              text: `${label}: ${percentage}%`,
              fillStyle: dataset.backgroundColor[i],
              strokeStyle: dataset.backgroundColor[i],
              fontColor: textColor,
              hidden: false,
              index: i
            };
          });
        };
        
        statusPieChart.update();
      }
    }
    
    // Load analytics data
    async function loadAnalytics() {
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        let url = '/api/analytics';
        if (startDate && endDate) {
            url += `?startDate=${startDate}&endDate=${endDate}`;
        }
        try {
            const response = await fetch(url);
            const data = await response.json();

            document.querySelectorAll('.analytic-item span').forEach(el => {
                el.parentElement.classList.add('updating');
                setTimeout(() => el.parentElement.classList.remove('updating'), 800);
            });

            setTimeout(() => {
                // Calculate success rate (sent / total attempts)
                const totalAttempts = (data.totalSent || 0) + (data.totalFailed || 0);
                const successRate = totalAttempts > 0 ? ((data.totalSent || 0) / totalAttempts * 100).toFixed(1) : 0;
                
                // Calculate today's stats
                const today = new Date().toLocaleDateString();
                const todayData = data.timeline?.find(t => t.date === today) || { sent: 0 };
                
                document.getElementById('totalSent').textContent = data.totalSent || 0;
                document.getElementById('totalFailed').textContent = data.totalFailed || 0;
                document.getElementById('totalInvalid').textContent = data.statusBreakdown?.Invalid || 0;
                document.getElementById('uniqueRecipients').textContent = data.uniqueRecipients || 0;
                document.getElementById('mostActiveHour').textContent = data.mostActiveHour || '-';
                document.getElementById('catalogsSent').textContent = data.totalCatalogs || 0;
                
                // Update daily activity
                document.getElementById('todayMessages').textContent = todayData.sent || 0;
                document.getElementById('todayCatalogs').textContent = Math.floor((todayData.sent || 0) * 0.8); // Estimate
                document.getElementById('successRate').textContent = successRate + '%';
                document.getElementById('processingSpeed').textContent = '12/min'; // Based on 5-second delay

                // Update charts
                if (analyticsChart && data.timeline) {
                    analyticsChart.data.labels = data.timeline.map(item => item.date);
                    analyticsChart.data.datasets[0].data = data.timeline.map(item => item.sent);
                    // Estimate catalogs as 80% of sent messages
                    analyticsChart.data.datasets[1].data = data.timeline.map(item => Math.floor(item.sent * 0.8));
                    analyticsChart.update();
                }
                if (hourlyTrendChart && data.hourlyTrend) {
                    hourlyTrendChart.data.labels = data.hourlyTrend.map(item => item.hour);
                    hourlyTrendChart.data.datasets[0].data = data.hourlyTrend.map(item => item.count);
                    hourlyTrendChart.update();
                }
                if (statusPieChart && data.statusBreakdown) {
                    // Only show actually tracked statuses
                    const trackedStatuses = {
                        'Sent': data.statusBreakdown.Sent || 0,
                        'Failed': data.statusBreakdown.Failed || 0,
                        'Invalid': data.statusBreakdown.Invalid || 0
                    };
                    statusPieChart.data.labels = Object.keys(trackedStatuses);
                    statusPieChart.data.datasets[0].data = Object.values(trackedStatuses);
                    statusPieChart.update();
                }
                
            }, 250);

        } catch (error) {
            console.error('Failed to load analytics:', error);
        }
    }
    
    // Theme toggle
    function setupThemeToggle() {
      const currentTheme = localStorage.getItem('theme');
      
      if (currentTheme === 'dark-mode') {
        document.body.classList.add('dark-mode');
        themeToggle.checked = true;
      }
      
      themeToggle.addEventListener('change', function() {
        if (this.checked) {
          document.body.classList.add('dark-mode');
          localStorage.setItem('theme', 'dark-mode');
        } else {
          document.body.classList.remove('dark-mode');
          localStorage.setItem('theme', 'light-mode');
        }
        // Update charts for better visibility in dark mode
        updateChartColors();
      });
    }
    
    // Event listeners
    function setupEventListeners() {
      startBtn.addEventListener('click', async () => {
        try {
            const response = await fetch('/start', { method: 'POST' });
            const result = await response.json();
            showToast(result.message || "Processing started", response.ok);
        } catch (error) {
            showToast("Failed to start processing", false);
        }
      });
      
      stopBtn.addEventListener('click', async () => {
        try {
            const response = await fetch('/stop', { method: 'POST' });
            const result = await response.json();
            showToast(result.message || "Processing stopped", response.ok);
        } catch (error) {
            showToast("Failed to stop processing", false);
        }
      });
      
      resetBtn.addEventListener('click', async () => {
        if (confirm("Are you sure you want to reset the session? You will need to scan the QR code again.")) {
            try {
                const response = await fetch('/reset', { method: 'POST' });
                const result = await response.json();
                showToast(result.message || "Session has been reset", response.ok);
            } catch (error) {
                showToast("Failed to reset session", false);
            }
        }
      });
      
      pdfUpload.addEventListener('change', () => {
        if (pdfUpload.files.length > 0) {
          pdfFileName.textContent = pdfUpload.files[0].name;
        } else {
          pdfFileName.textContent = 'Choose a PDF file';
        }
      });
      
      uploadBtn.addEventListener('click', async () => {
        if (!pdfUpload.files.length) {
          showToast('Please select a PDF file first', false);
          return;
        }
        const formData = new FormData();
        formData.append('pdf', pdfUpload.files[0]);
        try {
            const response = await fetch('/upload-pdf', { method: 'POST', body: formData });
            const result = await response.json();
            showToast(result.message || "PDF uploaded successfully!", response.ok);
        } catch (error) {
            showToast('Failed to upload PDF', false);
        }
      });
      
      filterBtn.addEventListener('click', () => {
        showToast('Filters applied successfully', true);
        loadAnalytics();
        loadLogs();
      });
      
      resetFilterBtn.addEventListener('click', () => {
        const newToday = new Date();
        const newStartOfJuly = new Date(2025, 6, 1); // July 1st, 2025
        
        startDateInput.value = formatDate(newStartOfJuly);
        endDateInput.value = formatDate(newToday);
        showToast('Filters reset', true);
        loadAnalytics();
        loadLogs();
      });
    }

    async function fetchStatus() {
      try {
        const response = await fetch('/status');
        const statusData = await response.json();
        updateStatus(statusData.status, statusData.processing);
        updateBotStatus(statusData.processing);
        if (statusData.qrCode) {
          showQR(statusData.qrCode);
        } else {
          hideQR();
        }
      } catch (error) {
        updateStatus('disconnected', false);
        updateBotStatus(false);
      }
    }
    
    // Initialize the dashboard when DOM is loaded
    document.addEventListener('DOMContentLoaded', async () => {
      // Load configuration first
      await loadConfig();
      
      setupThemeToggle();
      setupEventListeners();
      initDashboard();
      
      // Initialize bot status
      updateBotStatus(false);
      
      // Update chart colors after initialization
      setTimeout(updateChartColors, 1000);
      
      // Initial fetch and then set intervals
      fetchStatus();
      setInterval(fetchStatus, 2000);
      setInterval(loadLogs, 10000);
      setInterval(loadAnalytics, 15000);
    });
  </script>
</body>
</html>